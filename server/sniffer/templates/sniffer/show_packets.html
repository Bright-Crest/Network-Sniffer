{% extends 'base.html' %}

{% load static %}

{% block style %}

{% endblock %}

{% block content %}
  <div class="container mt-3">
    <h1>抓包结果</h1>
    <h6 class="text-secondary">推荐停止捕获后再进行查看包等操作，以避免出现页面卡顿等情况</h6>

    <div class="sticky-top" style="top: 64.52px;">
      <div class="mt-3"></div>
      <div class="py-2">
        <div>
          <form id="sseForm" name="sseForm" method="post" novalidate>
            {% csrf_token %}
            <input type="hidden" name="sseData" value="restart" />
            <button id="sseRestart" class="btn btn-primary" type="submit" {% if is_history %}disabled{% endif %}>重新开始捕获分组</button>
            <button id="sseStop" class="btn btn-primary" type="button" {% if is_stopped %}disabled{% endif %}>停止捕获分组</button>
            <button class="btn btn-primary" type="button" onclick="window.location.href='{% url 'sniffer:index' %}';">返回网络嗅探器主页面</button>
          </form>
        </div>
      </div>
    </div>

    <div class="mt-0" style="max-height: 600px; overflow-y: auto;">
      <table id="packetsTable" class="table table-hover">
        <thead class="sticky-top" style="z-index: 0;">
          <tr>
            <th>序号</th>
            <th>时间</th>
            <th>Source</th>
            <th>Destination</th>
            <th>协议</th>
            <th>长度</th>
            <th>信息</th>
          </tr>
        </thead>
        <tbody class="table-group-divider">
          {% include 'sniffer/show_packets_table_rows.html' %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script type="text/javascript">
    function sendFormXhr(formData, url) {
      // 不刷新页面提交
      let xhr = new XMLHttpRequest()
      xhr.open('POST', url)
      xhr.send(formData)
    
      // 只是方便控制台检查是否提交成功
      xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status === 200) {
            console.log('XHR submitted successfully')
          } else {
            console.log('Error submitting XHR')
            // only for debug
            // window.document.body.innerHTML = xhr.responseText
          }
        }
      }
    }
    
    function fillFrom(id, dict) {
      var form = window.document.getElementById(id)
      var formData = new FormData(form)
      for (var key in dict) {
        formData.set(key, dict[key])
      }
      return formData
    }
    
    is_stopped = {% if is_stopped %} true {% else %} false {% endif %}

    const sleep = (delay) => new Promise((resolve) => setTimeout(resolve, delay))

    $(document).ready(function () {
      $('#sseStop').click(function () {
        sendFormXhr(fillFrom('sseForm', { sseData: 'stop' }), '{{ request.get_full_path }}')
        is_stopped = true
        $(this).prop('disabled', true)
      })
    })
    
    window.onload = function () {
      // 禁用“确认重新提交表单”
      window.history.replaceState(null, null, window.location.href)
    
      // update page without refresh and call this function repeatedly every
      // 1 second until the stop button is clicked
      function send_refresh() {
        last_row_element = window.document.getElementsByClassName('last-row')[0]
        last_row = 0
        if (last_row_element) {
          last_row = last_row_element.id.split('_')[1]
        }
        console.log('last row: ' + last_row)
    
        let xhr = new XMLHttpRequest()
        xhr.open('GET', '{{ request.get_full_path }}' + '?last_row=' + last_row, false)
        xhr.send()
        if (xhr.status === 200) {
          if (xhr.responseText !== '\n' && xhr.responseText !== '') {
            if (last_row_element) {
              last_row_element.classList.remove('last-row')
            }
            window.document.getElementById('packetsTable').innerHTML += xhr.responseText
            console.log('update page without refresh')
          }
          return true
        } else {
          return false
        }
      }
    
      async function update() {
        while (!is_stopped) {
          await sleep(500)
          if (send_refresh() === false) {
            break
          }
        }
      }
      update()
    }
  </script>
{% endblock %}
